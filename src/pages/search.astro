---
import { SearchForm } from '@/components/SearchForm';
import Layout from '@/layouts/Layout.astro';

const isDev = import.meta.env.DEV;
const query = Astro.url.searchParams.get('q') || '';
---

<Layout title="Search">
  <Fragment slot="head">
    <link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
    <script is:inline src="/pagefind/pagefind-ui.js"></script>
  </Fragment>

  <div class="mx-auto max-w-4xl py-8">
    <h1 class="mb-6 text-3xl font-bold text-slate-900 dark:text-white">
      Search OpenAPI Tools
    </h1>

    <SearchForm
      client:load
      className="mb-6"
      placeholder="Search tools, categories, docs..."
      defaultValue={query}
      autoFocus
    />

    {
      isDev && (
        <div class="mb-6 rounded-lg border border-amber-200 bg-amber-50 p-4 text-amber-800 dark:border-amber-800 dark:bg-amber-900/20 dark:text-amber-200">
          <p class="font-medium">Search unavailable in dev mode</p>
          <p class="mt-1 text-sm">
            Pagefind indexes the site at build time. To test search, run:
          </p>
          <code class="mt-2 block rounded bg-amber-100 p-2 text-xs dark:bg-amber-900/40">
            pnpm build && cd dist && npx serve
          </code>
        </div>
      )
    }

    <div id="search"></div>
  </div>

  <style is:global>
    /* Hide Pagefind's default input - we use our own */
    .pagefind-ui__form {
      display: none !important;
    }

    .pagefind-ui {
      --pagefind-ui-scale: 1;
      --pagefind-ui-primary: #10b981;
      --pagefind-ui-text: #1e293b;
      --pagefind-ui-background: #ffffff;
      --pagefind-ui-border: #e2e8f0;
      --pagefind-ui-tag: #f1f5f9;
      --pagefind-ui-border-width: 1px;
      --pagefind-ui-border-radius: 6px;
      --pagefind-ui-font: inherit;
    }

    .dark .pagefind-ui {
      --pagefind-ui-primary: #10b981;
      --pagefind-ui-text: #f1f5f9;
      --pagefind-ui-background: #1e293b;
      --pagefind-ui-border: #334155;
      --pagefind-ui-tag: #334155;
    }

    .pagefind-ui__result-link {
      color: #10b981 !important;
    }

    .pagefind-ui__result-link:hover {
      text-decoration: underline !important;
    }

    .pagefind-ui__message {
      padding: 1rem 0;
    }
  </style>

  <script is:inline>
    window.addEventListener('load', () => {
      const pagefind = new PagefindUI({
        element: '#search',
        showSubResults: true,
      });

      // Get initial query from URL and trigger search
      // Use requestAnimationFrame to ensure PagefindUI is fully initialized
      const params = new URLSearchParams(window.location.search);
      const initialQuery = params.get('q');
      if (initialQuery) {
        requestAnimationFrame(() => {
          pagefind.triggerSearch(initialQuery);
        });
      }
    });
  </script>
</Layout>
