---
import type { GetStaticPaths } from 'astro';
import { getCollection, getEntry } from 'astro:content';

import Badge from '@/components/Badge';
import { Button } from '@/components/Button';
import ExternalArticle from '@/components/ExternalArticle';
import RepoIcon from '@/components/icons/RepoIcon';
import WebsiteIcon from '@/components/icons/WebsiteIcon';
import Languages from '@/components/Languages';
import Link from '@/components/Link';
import PageHeader from '@/components/PageHeader.astro';
import Layout from '@/layouts/Layout.astro';
import PostHogLayout from '@/layouts/PostHogLayout.astro';
import enrichFeaturedArticles from '@/utils/enrichFeaturedArticles';
import { isSponsorshipActive } from '@/utils/sponsorship';
import {
  createBreadcrumbSchema,
  createSoftwareApplicationSchema,
  serializeSchema,
} from '@/utils/structuredData';

// 1. Generate a new path for every collection entry
export const getStaticPaths: GetStaticPaths = async () => {
  const tools = await getCollection('tools');
  return tools.map((category) => ({
    params: { slug: category.slug },
  }));
};

// 2. For your template, you can get the entry directly from the prop
const { slug } = Astro.params;
const tool = await getEntry('tools', slug as string);

if (!tool) {
  throw new Error(`No category found for slug ${slug}`);
}

const languages: Record<string, boolean> = tool.data?.languages || {};

const { Content } = await tool.render();

const enrichedFeaturedArticles = await enrichFeaturedArticles(tool.data);

// Fetch category details for each category reference
const categories = await Promise.all(
  tool.data.categories.map((categoryRef) => getEntry(categoryRef))
);
---

<PostHogLayout>
  <Layout
    title={tool.data.name}
    description={tool.data.description}
    ogImage={`https://openapi.tools/tools/${slug}.og.png`}
  >
    {/* Breadcrumb Structured Data */}
    <script
      is:inline
      slot="head"
      type="application/ld+json"
      set:html={serializeSchema(
        createBreadcrumbSchema([
          { name: 'Home', url: 'https://openapi.tools/' },
          { name: 'Tools', url: 'https://openapi.tools/' },
          { name: tool.data.name, url: `https://openapi.tools/tools/${slug}` },
        ])
      )}
    />
    {/* SoftwareApplication Structured Data */}
    <script
      is:inline
      slot="head"
      type="application/ld+json"
      set:html={serializeSchema(
        createSoftwareApplicationSchema({
          name: tool.data.name,
          description: tool.data.description,
          link: tool.data.link,
          repo: tool.data.repo,
          slug: slug as string,
        })
      )}
    />
    <PageHeader
      title={tool.data.name}
      description={tool.data.description}
      url={tool.data.link}
      isSponsor={isSponsorshipActive(tool.data)}
    >
      {/* Display prominent links to website and repo */}
      <div class="mt-4 flex flex-wrap gap-3">
        {
          tool.data.link ? (
            <Button
              href={tool.data.link}
              variant="primary"
              isSponsored={isSponsorshipActive(tool.data)}
              className="inline-flex items-center gap-2"
            >
              <WebsiteIcon className="h-4 w-4" />
              Visit Website
            </Button>
          ) : (
            <p>No Website</p>
          )
        }
        {
          tool.data.repo && (
            <Button
              href={tool.data.repo}
              variant="secondary"
              isSponsored={isSponsorshipActive(tool.data)}
              className="inline-flex items-center gap-2"
            >
              <RepoIcon className="h-4 w-4" repo={tool.data.repo} />
              View Repository
            </Button>
          )
        }
      </div>

      {/* More Details Section */}
      <div
        class="mt-8 rounded-lg border border-slate-200 bg-slate-50 p-6 dark:border-slate-700 dark:bg-slate-800/50"
      >
        <h2
          class="mb-4 text-lg font-semibold text-slate-900 dark:text-slate-100"
        >
          More Details
        </h2>

        <div class="space-y-4">
          {/* Categories */}
          {
            categories.length > 0 && (
              <div>
                <h3 class="mb-2 text-sm font-medium text-slate-700 dark:text-slate-300">
                  Categories
                </h3>
                <div class="flex flex-wrap gap-2">
                  {categories.map(
                    (category) =>
                      category && (
                        <Link
                          href={`/categories/${category.slug}`}
                          className="no-underline"
                        >
                          <Badge variant="blue">{category.data.name}</Badge>
                        </Link>
                      )
                  )}
                </div>
              </div>
            )
          }

          {/* OpenAPI Versions */}
          {
            tool.data.oasVersions && (
              <div>
                <h3 class="mb-2 text-sm font-medium text-slate-700 dark:text-slate-300">
                  OpenAPI Versions Supported
                </h3>
                <div class="flex flex-wrap gap-2">
                  {tool.data.oasVersions.v2 && (
                    <Badge variant="green">v2.0</Badge>
                  )}
                  {tool.data.oasVersions.v3 && (
                    <Badge variant="green">v3.0</Badge>
                  )}
                  {tool.data.oasVersions.v3_1 && (
                    <Badge variant="green">v3.1</Badge>
                  )}
                  {tool.data.oasVersions.v3_2 && (
                    <Badge variant="green">v3.2</Badge>
                  )}
                </div>
              </div>
            )
          }

          {/* Languages */}
          {
            Object.keys(languages).length > 0 && (
              <div>
                <h3 class="mb-2 text-sm font-medium text-slate-700 dark:text-slate-300">
                  Languages
                </h3>
                <div class="not-prose">
                  <Languages languages={languages} />
                </div>
              </div>
            )
          }
        </div>
      </div>
    </PageHeader>
    <main
      class="prose prose-lg dark:prose-invert prose-headings:text-slate-700/90 dark:prose-headings:text-slate-300/90"
    >
      <Content />

      <hr class="my-4" />

      {
        enrichedFeaturedArticles && enrichedFeaturedArticles.length > 0 && (
          <>
            <Badge>Featured Articles</Badge>

            <section class="md-grid-cols-2 grid gap-4 lg:grid-cols-3">
              {enrichedFeaturedArticles.map((article) => (
                <ExternalArticle {...article.og} />
              ))}
            </section>
          </>
        )
      }
    </main>
  </Layout>
</PostHogLayout>
