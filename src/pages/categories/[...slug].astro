---
import type { GetStaticPaths } from 'astro';
import { getCollection, getEntry } from 'astro:content';

import { FilterableToolsList } from '@/components/filters/FilterableToolsList';
import PageHeader from '@/components/PageHeader.astro';
import Layout from '@/layouts/Layout.astro';
import PostHogLayout from '@/layouts/PostHogLayout.astro';
import {
  createBreadcrumbSchema,
  createCollectionPageSchema,
  serializeSchema,
} from '@/utils/structuredData';

// 1. Generate a new path for every collection entry
export const getStaticPaths: GetStaticPaths = async () => {
  const categories = await getCollection('categories');
  return categories.map((category) => ({
    params: { slug: category.slug },
    props: { category },
  }));
};

// 2. For your template, you can get the entry directly from the prop
const { slug } = Astro.params;
const category = await getEntry('categories', slug as string);

if (!category) {
  throw new Error(`No category found for slug ${slug}`);
}

const { Content } = await category.render();

// 3 get entries for this category from the Tools collection
// Note: category.id includes .md extension, but tool category references don't
const categoryIdWithoutExt = category.id.replace(/\.md$/, '');

const allTools = (await getCollection('tools')).filter((tool) => {
  if (!tool.data.categories) {
    return false;
  }
  const categories = tool.data.categories;
  // look through the categories list to see if any of the categories matches category id
  return categories.some((cat) => cat.id === categoryIdWithoutExt);
});

// get all the sponsored tools
const sponsoredTools = allTools
  .filter((tool) => tool.data.sponsorship)
  .sort((a, b) => {
    // sort sponsored tools by start date
    if (!a.data.sponsorship || !b.data.sponsorship) {
      return 0;
    }
    const aDate = new Date(a.data.sponsorship.startDate);
    const bDate = new Date(b.data.sponsorship.startDate);
    return aDate.getTime() - bDate.getTime();
  });

// get all the tools that are not sponsored
const nonSponsoredTools = allTools
  .filter((tool) => !tool.data.sponsorship)
  .sort((a, b) => {
    return a.data.name.localeCompare(b.data.name);
  });

const tools = [...sponsoredTools, ...nonSponsoredTools];
const toolsData = tools.map((tool) => ({
  category: category.data,
  tool: tool.data,
  slug: tool.slug,
}));
---

<PostHogLayout>
  <Layout
    title={category.data.name}
    description={category.data.description}
    ogImage={`https://openapi.tools/categories/${slug}.og.png`}
  >
    {/* Breadcrumb Structured Data */}
    <script
      is:inline
      slot="head"
      type="application/ld+json"
      set:html={serializeSchema(
        createBreadcrumbSchema([
          { name: 'Home', url: 'https://openapi.tools/' },
          { name: 'Categories', url: 'https://openapi.tools/' },
          {
            name: category.data.name,
            url: `https://openapi.tools/categories/${slug}`,
          },
        ])
      )}
    />
    {/* CollectionPage Structured Data */}
    <script
      is:inline
      slot="head"
      type="application/ld+json"
      set:html={serializeSchema(
        createCollectionPageSchema({
          name: category.data.name,
          description: category.data.description,
          slug: slug as string,
          tools: tools.map((t) => ({ name: t.data.name, slug: t.slug })),
        })
      )}
    />

    <PageHeader
      title={category.data.name}
      description={category.data.description}
    >
      {/* render the body of the markdown file for this category */}
      <div
        class="prose prose-lg dark:prose-invert prose-headings:text-slate-700/90 dark:prose-headings:text-slate-300"
      >
        <Content />
      </div>
    </PageHeader>

    <main
      class="prose-lg dark:prose-invert prose-headings:text-slate-700/90 dark:prose-headings:text-slate-300 w-full"
    >
      <h2 class="prose mb-4 text-2xl font-bold">
        {category.data.name}
      </h2>
      <section class="prose w-full max-w-none">
        <FilterableToolsList
          client:only="react"
          tools={toolsData}
        />
      </section>
    </main>
  </Layout>
</PostHogLayout>
