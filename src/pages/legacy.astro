---
import { getCollection } from 'astro:content';

import Link from '@/components/Link';
import PageHeader from '@/components/PageHeader.astro';
import { DataTable } from '@/components/table/DataTable';
import { LegacyToolColumns } from '@/components/table/LegacyToolColumns';
import Layout from '@/layouts/Layout.astro';
import PostHogLayout from '@/layouts/PostHogLayout.astro';
import {
  createBreadcrumbSchema,
  createCollectionPageSchema,
  serializeSchema,
} from '@/utils/structuredData';

// Get all tools
const allTools = await getCollection('tools');

// Filter for legacy tools: tools that support v2 or v3 but NOT v3_1 or v3_2
const legacyTools = allTools.filter((tool) => {
  const versions = tool.data.openApiVersions;
  const hasLegacyVersion = versions.v2 || versions.v3;
  const hasModernVersion = versions.v3_1 || versions.v3_2;
  return hasLegacyVersion && !hasModernVersion;
});

// Get all categories
const allCategories = await getCollection('categories');

// Sort categories by name
const sortedCategories = allCategories.sort((a, b) =>
  a.data.name.localeCompare(b.data.name)
);

// Group tools by category
const toolsByCategory = new Map<string, typeof legacyTools>();

for (const category of sortedCategories) {
  const categoryIdWithoutExt = category.id.replace(/\.md$/, '');
  const categoryTools = legacyTools
    .filter((tool) => {
      const categories = tool.data.categories;
      return categories.some((cat) => cat.id === categoryIdWithoutExt);
    })
    // Sort by sponsored first, then alphabetically
    .sort((a, b) => {
      // Sponsored tools first
      if (a.data.sponsorship && !b.data.sponsorship) return -1;
      if (!a.data.sponsorship && b.data.sponsorship) return 1;
      // Then alphabetically
      return a.data.name.localeCompare(b.data.name);
    });

  if (categoryTools.length > 0) {
    toolsByCategory.set(category.id, categoryTools);
  }
}
---

<PostHogLayout>
  <Layout
    title="Legacy OpenAPI Tools"
    description="High-quality OpenAPI tools for v3.0 and v2.0 that haven't yet added support for v3.1 or v3.2"
  >
    {/* Breadcrumb Structured Data */}
    <script
      is:inline
      slot="head"
      type="application/ld+json"
      set:html={serializeSchema(
        createBreadcrumbSchema([
          { name: 'Home', url: 'https://openapi.tools/' },
          { name: 'Legacy Tools', url: 'https://openapi.tools/legacy' },
        ])
      )}
    />
    {/* CollectionPage Structured Data */}
    <script
      is:inline
      slot="head"
      type="application/ld+json"
      set:html={serializeSchema(
        createCollectionPageSchema({
          name: 'Legacy OpenAPI Tools',
          description:
            "High-quality OpenAPI tools for v3.0 and v2.0 that haven't yet added support for v3.1 or v3.2",
          url: 'https://openapi.tools/legacy',
          tools: legacyTools.slice(0, 10).map((t) => ({
            name: t.data.name,
            url: `https://openapi.tools/tools/${t.slug}`,
          })),
        })
      )}
    />
    <PageHeader
      title="Legacy OpenAPI Tools"
      description="Tools for historic OpenAPI versions"
    >
      <div
        class="prose prose-lg dark:prose-invert prose-headings:text-slate-700/90 dark:prose-headings:text-slate-300"
      >
        <p>
          This is the legacy list of old OpenAPI tools, covering v3.0 and v2.0
          tools that have not yet added support for v3.1 or v3.2. Please visit
          the <Link href="/">main site</Link> for the latest tools.
        </p>
      </div>
    </PageHeader>

    <main class="w-full">
      <div class="mb-8 rounded-lg bg-slate-50 p-6 dark:bg-slate-800/50">
        <h2
          class="mb-4 text-xl font-semibold text-slate-700/90 dark:text-slate-300"
        >
          Categories
        </h2>
        <ul
          class="prose dark:prose-invert list-disc pl-6 md:columns-2 md:gap-8 lg:columns-3"
        >
          {
            Array.from(toolsByCategory.keys()).map((categoryId) => {
              const category = sortedCategories.find(
                (c) => c.id === categoryId
              );
              if (!category) return null;
              const categorySlug = category.slug;
              return (
                <li>
                  <a
                    href={`#${categorySlug}`}
                    class="text-emerald-600 hover:underline dark:text-emerald-300"
                  >
                    {category.data.name}
                  </a>
                </li>
              );
            })
          }
        </ul>
      </div>

      {
        Array.from(toolsByCategory.entries()).map(([categoryId, tools]) => {
          const category = sortedCategories.find((c) => c.id === categoryId);
          if (!category) return null;

          const toolsData = tools.map((tool) => ({
            category: category.data,
            tool: tool.data,
            slug: tool.slug,
          }));

          return (
            <section id={category.slug} class="mb-12 scroll-mt-20">
              <h2 class="mb-2 text-2xl font-bold text-slate-700/90 dark:text-slate-300">
                <a
                  href={`#${category.slug}`}
                  class="hover:text-emerald-600 dark:hover:text-emerald-300"
                >
                  {category.data.name}
                </a>
              </h2>
              <p class="prose dark:prose-invert mb-4">
                {category.data.description}
              </p>
              <div class="w-full max-w-none">
                <DataTable data={toolsData} columns={LegacyToolColumns} />
              </div>
            </section>
          );
        })
      }

      <div class="mt-8 text-center">
        <p class="prose dark:prose-invert">
          Looking for more modern tools? Check out the{' '}
          <Link href="/">main list</Link>.
        </p>
      </div>
    </main>
  </Layout>
</PostHogLayout>
